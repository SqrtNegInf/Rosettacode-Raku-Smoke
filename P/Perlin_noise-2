#!/usr/bin/env perl6
#u# http://rosettacode.org/wiki/Perlin_noise
#c# 2016-01-18 <>RC
#m# MOAR: OK
#j#  JVM: OK
#n# kludge for JVM: 'my' instead of 'constant' for @p (java.lang.IllegalArgumentException: bad parameter count 259)
#n# 2022-11-22 Grondilu - use emojis to encode the permutation
#n#            unlike main version, here JVM gives a different answer

#constant @p =
my @p = flat { @_.sort.antipairs.Hash{@_} }("
ğŸ˜…ğŸ˜ğŸ“¸ğŸ‘‘ğŸ‘âœŒ ğŸ’»âœŠğŸ˜»ğŸ’€ğŸ’ğŸƒğŸ˜²ğŸ¤¦â˜ºğŸ¤™ğŸ”µğŸŒ•ğŸ’ğŸŒğŸ¶ğŸ–•<E2><9A>ğŸ’†ğŸŒ–ğŸ¤­â£âš½â¡ğŸ˜®â˜¹ğŸ˜‚
ğŸ¥°ğŸ’£ğŸ¤§ğŸ·â–¶ğŸŒˆğŸ˜µğŸğŸ‘¼ğŸ¦‹ğŸ¤ğŸ™‚ğŸ’ŸğŸŒ”âœ…ğŸŒ‘ğŸ’ğŸ˜ŸğŸŒ’ğŸ‘ğŸ¤ªğŸ˜ƒğŸ‘ğŸ‘ğŸ˜œâ“ğŸ’©ğŸ“£ğŸ˜™ğŸ˜–ğŸµğŸ˜
ğŸ¶ğŸ˜“ğŸƒğŸ“ŒğŸ”´ğŸŒºğŸŒŠğŸ˜”ğŸ¾ğŸ˜€ğŸ˜ŒğŸ¤£ğŸ‘‰ğŸ’™<F0><9F><A4>ğŸ’¦ğŸ»ğŸ™‹ğŸ’¿ğŸ¤¢ğŸ¤‘ğŸ’“ğŸ‘¶ğŸŒğŸğŸŒ¸ğŸ¥€ğŸŒšğŸ¤·ğŸ’ğŸ–¤ğŸŠ
ğŸ‰â­ğŸ‚ğŸ˜â˜€ğŸš©ğŸ‘†ğŸ‰ğŸ™ˆğŸ¸ğŸ’¾ğŸ˜«ğŸ™‡ğŸ‘â„ğŸ˜—ğŸ˜¹ğŸ˜´ğŸ“ğŸ’¸ğŸ’ğŸ˜¬ğŸ˜ğŸ‘ŒğŸ˜’ğŸ’‹ğŸ’—ğŸ˜¶ğŸ˜›ğŸ˜ªâ˜ğŸˆ
ğŸ€ğŸš¶ğŸ¤ğŸ¥µğŸ’¨ğŸ’§â˜ ğŸ™ğŸŒ—ğŸ˜ğŸ’¡ğŸ’ªğŸªğŸ‘ˆğŸ‘‹ğŸ™ŒğŸ™†ğŸ™…ğŸºğŸ¤ğŸŒ¹âœ”ğŸ“âœ¨ğŸ˜¤ğŸ˜­ğŸŒŒğŸŒŸğŸ¤—ğŸ˜¥ğŸ˜˜ğŸ™
ğŸ’¢ğŸ¥³ğŸ˜†â˜„ğŸŒ´ğŸ˜ˆğŸ˜‘ğŸ¼ğŸ¤“ğŸ˜‡ğŸ’ŒğŸ˜‰ğŸ˜•ğŸŒ±ğŸ˜šâš¡ğŸ’°â¤ğŸŒ˜ğŸ§âŒğŸ’…ğŸ’–ğŸ’˜ğŸ‘…ğŸ’›ğŸ¤˜ğŸ¤¤<F0><9F><98>ğŸ˜©ğŸ’šğŸ’
ğŸ›° ğŸ¥‚ğŸ’ƒğŸ¤ŸğŸ¥ºğŸŒ“ğŸ¤¯ğŸ˜±ğŸ¤«ğŸ™ŠğŸ–¥ âœˆğŸ˜¯ğŸ˜¡ğŸ˜ğŸ¤®ğŸ‘‡ğŸŒ¿ğŸ—£ ğŸ¤¨ğŸ¥´âœ‹ğŸ¤¬ğŸ’•ğŸŒ»ğŸ˜°ğŸš€ğŸŒğŸ˜£ğŸ˜·ğŸ’”ğŸ˜‹
ğŸ˜¨ğŸ‘ŠğŸ™ƒğŸ˜ğŸ’ğŸ’¥ğŸŒ¼ğŸŒ·ğŸ’«â˜•ğŸ˜„ğŸ§¡ğŸ”¥ğŸ¤©ğŸ™„ğŸ‘»ğŸ¤”ğŸ’œğŸ¤ğŸŒâ¬‡ğŸ†ğŸ¤²ğŸ•ºğŸ’¯ğŸ˜³ğŸ‘€ğŸŠğŸš¨ğŸ€ğŸ˜ŠğŸ˜¢
".words.join.comb) xx 2;

sub fade($_) { $_ Ã— $_ Ã— $_ Ã— ($_ Ã— ($_ Ã— 6 - 15) + 10) }

sub lerp($t, $a, $b) { $a + $t Ã— ($b - $a) }

sub grad($h is copy, $x, $y, $z) {
    $h +&= 15;
    my $u = $h < 8 ?? $x !! $y;
    my $v = $h < 4 ?? $y !! $h == 12|14 ?? $x !! $z;
    (($h +& 1) ?? -$u !! $u) + (($h +& 2) ?? -$v !! $v);
}

sub noise($x is copy, $y is copy, $z is copy) {
    my ($X, $Y, $Z) = ($x, $y, $z)Â».floor Â»+&Â» 255;
    my ($u, $v, $w) = map &fade, $x -= $X, $y -= $Y, $z -= $Z;
    my ($AA, $AB) = @p[$_] + $Z, @p[$_ + 1] + $Z given @p[$X] + $Y;
    my ($BA, $BB) = @p[$_] + $Z, @p[$_ + 1] + $Z given @p[$X + 1] + $Y;
    lerp($w, lerp($v, lerp($u, grad(@p[$AA    ], $x    , $y    , $z     ),  
                               grad(@p[$BA    ], $x - 1, $y    , $z     )), 
                      lerp($u, grad(@p[$AB    ], $x    , $y - 1, $z     ),  
                               grad(@p[$BB    ], $x - 1, $y - 1, $z     ))),
             lerp($v, lerp($u, grad(@p[$AA + 1], $x    , $y    , $z - 1 ),  
                               grad(@p[$BA + 1], $x - 1, $y    , $z - 1 )), 
                      lerp($u, grad(@p[$AB + 1], $x    , $y - 1, $z - 1 ),
                               grad(@p[$BB + 1], $x - 1, $y - 1, $z - 1 ))));
}

say my $out = noise 3.14, 42, 7;

use Test;
is $out, $*VM ~~ /jvm/ ?? -0.117999706 !! -0.01892025318;
