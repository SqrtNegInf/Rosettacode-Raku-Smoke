#!/usr/bin/env raku
#u# http://rosettacode.org/wiki/Bioinformatics/Subsequence
#c# 2021-03-22 <RC
#m# MOAR: OK
#j# JVM:  OK
#n# new-disp 'srand' shift

srand 123;

my @res;

use String::Splice:ver<0.0.3>;

my $line = 80;
my $haystack = [~] <A C G T>.roll($line Ã— 8);
@res.push: 'Needle: ' ~ my $needle = [~] <A C G T>.roll(4);
my $these = $haystack ~~ m:g/<$needle>/;
my @match = $these.map: { .from, .pos }
@res.push: sprintf "From: %3s to %3s", |$_ for @match;
say join "\n", @res;

my $disp = $haystack.comb.batch($line)Â».join.join("\n");
for @match.reverse {
    $disp .= &splice(.[1] + .[1] div $line, "\e[0m" );
    $disp .= &splice(.[0] + .[0] div $line, "\e[31m");
}

my $moar1 = q:to/END/;
Needle: ATAA
From: 497 to 501
From: 557 to 561
From: 609 to 613
END

my $jvm1 = q:to/END/;
Needle: AACG
From: 250 to 254
From: 536 to 540
From: 547 to 551
From: 611 to 615
END

# not testing for now, will just change soon enough...
my $moar2 = q:to/END/;
END

my $jvm2 = q:to/END/;
GTCGTTGATGTATAAACTGCCACCCAGAGGATCGGGGCAAATGTTGGACGCTGCTCAGAAGGAGCCCATCCGAATTTTAC
ATGGACAGTAGTCCGTTGTGGCAATTCAGCCAACAAACCACCCACTCTTAAGACTATACTCATGTGAGTTGTACAGTTAG
ACACACAACTTTAACTTCCAAATCAAATTTGTTAAGTTGGCACAGAAGTGGGATGTGGACCGACCCCCGTTGGCTATTGC
GACCCGATTA[31mAACG[0mCTCGTCCGTAGCTCTCGCGAGTTCAAGTAAGTCCCGTGAGACATAATTCCGCACGAAATCTAATCT
AGTGCCTAGATGAAGCTGTCTATAGACAGGCAGCAGCCATCTGCATTCGAATAAAGCAGGTACAAGGACCCCAGTCGTGG
GCATGAAGCTACGCACTTTCCTTCTCGATGCTGGTCAGGCGTTACCTCTATTCCGATGATAATCACTGTAAACTTACCCA
TAGAACTCCGCATAAACATGTAGTGAGGAATAATATTTGGTCGAGCGATTATAACT[31mAACG[0mGAATCAC[31mAACG[0mATGATTAAC
CACAGTAATCTGTCACAGGTTCTGAGTCCTGGAAACCGAAATGCGTGCGAA[31mAACG[0mGCACGTGACTACAAAAGGATTGCTT
END

use Test;
if $*VM ~~ /jvm/ {
    is @res.join("\n"), chomp $jvm1;
    is $disp, chomp $jvm2;
} else {
    is @res.join("\n"), chomp $moar1;
   #is $disp, chomp $moar2;
}
