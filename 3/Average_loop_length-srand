#!/usr/bin/env perl6
#u# http://rosettacode.org/wiki/Average_loop_length
#c# 2016-05-09 <>RC, 2018-05-31 <RC, 2022-11-03 >RC
#m# MOAR: OK
#j#  JVM: OK
#n# 2017-08-10 'random' output changed on 
#n# 2019-??-?? with hash key order now variable, testing upgraded with ArrayHash
#n# 2020-09-01 something is unstable, run #2 flips between: 2.00% vs. 2.67%;
#n# 2020-10-07 different answers when run from interactive shell vs cron-launch? [update: now they've re-converged]
#n# 2021-03-01 still unstable when cron-launched
#n# 2021-03-10 problem mostly in #2, 1.33% (98+%), or 0.67%, and very rarely 0.00% (then #3-6 are different too)
#n# 2022-09-22 code is fixed, but results still completely unstable (MoarVM and JVM)
#n# 2022-10-02 d'oh, was using out-of-date module, not new/precompiled version
#n# 2022-10-06 dare I hope this is now working and stable?  Been the single most troublesome Raku task on RC...
die 'BROKEN on Mac-Pro' if qx/uname -a/ ~~ /'Mac-Pro'/;

srand 123456;

use ArrayHash;

constant MAX_N  = 20;
constant TRIALS = 100;

my @res;

for 1 .. MAX_N -> $N {
    my $empiric = TRIALS R/ [+] find-loop(random-mapping($N)).elems xx TRIALS;
    my $theoric = [+] map -> $k { $N ** ($k + 1) R/ [×] flat $k**2, $N - $k + 1 .. $N }, 1 .. $N;

    FIRST say " N    empiric      theoric      (error)";
    FIRST say "===  =========  ============  =========";

    @res.push: sprintf "%3d  %9.4f  %12.4f    (%4.2f%%)",
            $N,  $empiric, $theoric, 100 × abs($theoric - $empiric) / $theoric;
}

.say for @res;

sub random-mapping ($n) {
    my %temp = random-mapping-orig($n);
    my %pair := array-hash();
    %pair{$_} = %temp{$_} for sort %temp.keys;
    return %pair;
}

sub random-mapping-orig { hash .list Z=> .roll($_) given ^$^size }

sub find-loop { 0, | %^mapping{*} ...^ { (%){$_}++ } }

#exit;

my $linux = qq:to/END/;
  1     1.0000        1.0000    (0.00%)
  2     1.5400        1.5000    (2.67%)
  3     1.8300        1.8889    (3.12%)
  4     2.2500        2.2188    (1.41%)
  5     2.6200        2.5104    (4.37%)
  6     2.7000        2.7747    (2.69%)
  7     3.0400        3.0181    (0.72%)
  8     3.0500        3.2450    (6.01%)
  9     3.3100        3.4583    (4.29%)
 10     3.6600        3.6602    (0.01%)
 11     3.7300        3.8524    (3.18%)
 12     3.5500        4.0361    (12.04%)
 13     4.4200        4.2123    (4.93%)
 14     4.4600        4.3820    (1.78%)
 15     4.4000        4.5458    (3.21%)
 16     5.0700        4.7043    (7.77%)
 17     4.8800        4.8579    (0.46%)
 18     4.9300        5.0071    (1.54%)
 19     4.8900        5.1522    (5.09%)
 20     5.5300        5.2936    (4.47%)
END

my $imac = qq:to/END/;
  1     1.0000        1.0000    (0.00%)
  2     1.4200        1.5000    (5.33%)
  3     1.9000        1.8889    (0.59%)
  4     2.0300        2.2188    (8.51%)
  5     2.6500        2.5104    (5.56%)
  6     2.5600        2.7747    (7.74%)
  7     2.9600        3.0181    (1.93%)
  8     3.2000        3.2450    (1.39%)
  9     3.2300        3.4583    (6.60%)
 10     3.7200        3.6602    (1.63%)
 11     3.6700        3.8524    (4.73%)
 12     4.2700        4.0361    (5.80%)
 13     4.4000        4.2123    (4.45%)
 14     4.5300        4.3820    (3.38%)
 15     4.3100        4.5458    (5.19%)
 16     5.3200        4.7043    (13.09%)
 17     4.8000        4.8579    (1.19%)
 18     4.9800        5.0071    (0.54%)
 19     5.1300        5.1522    (0.43%)
 20     5.6500        5.2936    (6.73%)
END

use Test;
my $ref = qx/uname -a/ ~~ /'iMac'/ ?? $imac !! $linux;
is @res.join('').lc.subst(/<ws>/, '', :g), $ref.lc.subst(/<ws>/, '', :g);
