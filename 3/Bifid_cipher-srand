#!/usr/bin/env raku
#u# http://rosettacode.org/wiki/Bifid_cipher
#c# 2022-07-13 <RC
#m# MOAR: OK
#j# JVM:  OK
#n# 2023-09-11 results are for cronjob, not terminal
die 'BROKEN on Mac-Pro' if qx/uname -a/ ~~ /'Mac-Pro'/;

my @res;

srand 123456;

sub polybius ($text) {
    my $n = $text.chars.sqrt.narrow;
    $text.comb.kv.map: { $^v => ($^k % $n, $k div $n).join: ' ' }
}

sub encrypt ($message, %poly) {
    %poly.invert.hash{(flat reverse [Z] %poly{$message.comb}».words).batch(2)».reverse».join: ' '}.join
}

sub decrypt ($message, %poly) {
   %poly.invert.hash{reverse [Z] (reverse flat %poly{$message.comb}».words».reverse).batch($message.chars)}.join
}

for 'ABCDEFGHIKLMNOPQRSTUVWXYZ', 'ATTACKATDAWN',
    'BGWKZQPNDSIOAXEFCLUMTHYVR', 'FLEEATONCE',
   #(flat '_', '.', 'A'..'Z', 'a'..'z', 0..9).&pickall.join, 'The invasion will start on the first of January 2023.'.subst(/' '/, '_', :g)
    (flat '_', '.', 'A'..'Z', 'a'..'z', 0..9).pick(*).join, 'The invasion will start on the first of January 2023.'.subst(/' '/, '_', :g)
 -> $polybius, $message {
    my %polybius = polybius $polybius;
    @res.push: "\nUsing polybius:\n\t" ~ $polybius.comb.batch($polybius.chars.sqrt.narrow).join: "\n\t";
    @res.push: "\n  Message : $message";
    @res.push: "Encrypted : " ~ my $encrypted = encrypt $message, %polybius;
    @res.push: "Decrypted : " ~ decrypt $encrypted, %polybius;
}

.say for @res;

my $moar-macpro = q:to/END/;

Using polybius:
	A B C D E
	F G H I K
	L M N O P
	Q R S T U
	V W X Y Z

  Message : ATTACKATDAWN
Encrypted : DQBDAXDQPDQH
Decrypted : ATTACKATDAWN

Using polybius:
	B G W K Z
	Q P N D S
	I O A X E
	F C L U M
	T H Y V R

  Message : FLEEATONCE
Encrypted : UAEOLWRINS
Decrypted : FLEEATONCE

Using polybius:
	Y 8 v D j L I 2
	a f n r i P M g
	u G R U A e t .
	O 3 W z l s S 1
	B y C o 0 X 4 5
	6 E 9 m T Z q p
	Q h w 7 F x V c
	b d J k N K _ H

  Message : The_invasion_will_start_on_the_first_of_January_2023.
Encrypted : q.f83y_r1Wf.yJwdfWNgdnf5jDAPFRLotA0xQS7thqisV3wvY3c5g
Decrypted : The_invasion_will_start_on_the_first_of_January_2023.

Using polybius:
	A B C D E
	F G H I K
	L M N O P
	Q R S T U
	V W X Y Z

  Message : ATTACKATDAWN
Encrypted : DQBDAXDQPDQH
Decrypted : ATTACKATDAWN

Using polybius:
	B G W K Z
	Q P N D S
	I O A X E
	F C L U M
	T H Y V R

  Message : FLEEATONCE
Encrypted : UAEOLWRINS
Decrypted : FLEEATONCE

Using polybius:
	Y 8 v D j L I 2
	a f n r i P M g
	u G R U A e t .
	O 3 W z l s S 1
	B y C o 0 X 4 5
	6 E 9 m T Z q p
	Q h w 7 F x V c
	b d J k N K _ H

  Message : The_invasion_will_start_on_the_first_of_January_2023.
Encrypted : q.f83y_r1Wf.yJwdfWNgdnf5jDAPFRLotA0xQS7thqisV3wvY3c5g
Decrypted : The_invasion_will_start_on_the_first_of_January_2023.
END

my $moar-blead = q:to/END/;

Using polybius:
	A B C D E
	F G H I K
	L M N O P
	Q R S T U
	V W X Y Z

  Message : ATTACKATDAWN
Encrypted : DQBDAXDQPDQH
Decrypted : ATTACKATDAWN

Using polybius:
	B G W K Z
	Q P N D S
	I O A X E
	F C L U M
	T H Y V R

  Message : FLEEATONCE
Encrypted : UAEOLWRINS
Decrypted : FLEEATONCE

Using polybius:
	s r N 8 7 b F K
	S z W g u l d E
	C y O M D 0 k R
	x v 1 i w 4 Q a
	H Z 3 h p m j 2
	G L e o _ J . X
	T f B 5 9 t c V
	P n Y 6 q A U I

  Message : The_invasion_will_start_on_the_first_of_January_2023.
Encrypted : 9Jai8XovlFxtX.m.xFJtonx03pG1hzPiuhJHXlhuoDgS_vmn2z2Xk
Decrypted : The_invasion_will_start_on_the_first_of_January_2023.

Using polybius:
	A B C D E
	F G H I K
	L M N O P
	Q R S T U
	V W X Y Z

  Message : ATTACKATDAWN
Encrypted : DQBDAXDQPDQH
Decrypted : ATTACKATDAWN

Using polybius:
	B G W K Z
	Q P N D S
	I O A X E
	F C L U M
	T H Y V R

  Message : FLEEATONCE
Encrypted : UAEOLWRINS
Decrypted : FLEEATONCE

Using polybius:
	s r N 8 7 b F K
	S z W g u l d E
	C y O M D 0 k R
	x v 1 i w 4 Q a
	H Z 3 h p m j 2
	G L e o _ J . X
	T f B 5 9 t c V
	P n Y 6 q A U I

  Message : The_invasion_will_start_on_the_first_of_January_2023.
Encrypted : 9Jai8XovlFxtX.m.xFJtonx03pG1hzPiuhJHXlhuoDgS_vmn2z2Xk
Decrypted : The_invasion_will_start_on_the_first_of_January_2023.
END

use Test;
my $ref = qx/uname -a/ ~~ /'Mac-Pro'/ ?? $moar-macpro !! $moar-blead;
is @res.join('').subst(/<ws>/, '', :g), $ref.subst(/<ws>/, '', :g);
