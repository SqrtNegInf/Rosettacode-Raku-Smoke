#!/usr/bin/env perl6
#u# http://rosettacode.org/wiki/Generate_random_chess_position
#c# 2016-01-27 <RC
#m# MOAR: OK
#j#  JVM: OK
#n# 2020-11-03 results changed with: Rakudo(tm) v2020.10-51-g53b558fe0
#n# 2020-11-07 but once in a while flips back to old result apparently... (v2020.10-55-g2fe6420e8)

srand 123456;

sub pick-FEN {
    # First we chose how many pieces to place
    my $n = (2..32).pick;

    # Then we pick $n squares
    my @n = (^64).pick($n);

    # We try to find suitable king positions on non-adjacent squares.
    # If we could not find any, we return recursively
    return pick-FEN() unless
    my @kings[2] = first -> [$a, $b] {
        $a !== $b && abs($a div 8 - $b div 8) | abs($a mod 8 - $b mod 8) > 1
    }, (@n X @n);

    # We make a list of pieces we can pick (apart from the kings)
    my @pieces = <p P n N b B r R q Q>;

    # We make a list of two king symbols to pick randomly a black or white king
    my @k = <K k>.pick(*);

    return (gather for ^64 -> $sq {
        if $sq == @kings.any { take @k.shift }
        elsif $sq == @n.any {
            my $row = 7 - $sq div 8;
            take
            $row == 7 ?? @pieces.grep(none('P')).pick !!
            $row == 0 ?? @pieces.grep(none('p')).pick !!
            @pieces.pick;
        }
        else { take 'ø' }
    }).rotor(8)».join».subst(/ø+/,{ .chars }, :g).join('/') ~ ' w - - 0 1';
}

say my $result = pick-FEN();

use Test;
my $moar-cronjob  = '8/5K2/2p2q2/8/8/8/8/3k4 w - - 0 1';
my $moar-terminal = '7R/P2BK1r1/NkB1Nq2/3RRB2/6R1/2N5/3b3p/b2Pr3 w - - 0 1';
my $jvm           = '8/5k2/1Q1K4/2qn4/1P6/8/7p/q5B1 w - - 0 1';
is $result, chomp $*VM ~~ /jvm/ ?? $jvm !! $*IN.t ?? $moar-terminal !! $moar-cronjob;
